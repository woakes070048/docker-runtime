#!/bin/bash

set -a
set -e
set -o pipefail

if [ ! -z $DEPLOY_REPOSITORY ] && [ ! -z $DEPLOY_BRANCH ]; then
    deploy --skip-reload
else 
    runtime config:generate /opt/sitepilot/templates /opt/sitepilot/etc --configFile=/opt/sitepilot/runtime.yml --mergeFile=$APP_PATH_PUBLIC/.sitepilot/runtime.yml
fi

if [ -f /opt/sitepilot/etc/msmtp.conf ] ; then
    chmod 0600 /opt/sitepilot/etc/msmtp.conf
fi

if [ -d /opt/sitepilot/bin/entrypoint.d ] ; then
    run-parts --exit-on-error /opt/sitepilot/bin/entrypoint.d
fi

exec "$@"
